generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  CLIENT
  USER
  BARBERSHOP
  BARBER
}

enum CompetitionPeriodStatus {
  DRAFT
  ACTIVE
  CLOSED
}

model User {
  id               String         @id @default(cuid())
  email            String         @unique
  password         String
  name             String
  phone            String?   @unique
  phoneVerifiedAt  DateTime?
  avatar           String?
  location         String?
  role             UserRole       @default(USER)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  country          String?
  gender           String?
  avatarSeed       String?
  appointments  Appointment[]
  refreshTokens RefreshToken[]
  reviewList    Review[]
  fcmTokens     FcmToken[]
  favoriteBarbers FavoriteBarber[]
  workplaceId   String?
  workplace     Workplace?     @relation("WorkplaceUsers", fields: [workplaceId], references: [id])

  @@index([email])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model PhoneCodeSend {
  phone     String   @unique
  lastSentAt DateTime @updatedAt

  @@map("phone_code_sends")
}

model Specialty {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  barbers     Barber[]

  @@map("specialties")
}

model Workplace {
  id          String          @id @default(cuid())
  name        String          @unique
  address     String?
  city        String?
  latitude    Float?
  longitude   Float?
  description String?
  image       String?
  banner      String?
  rating      Float           @default(0.0)
  reviews     Int             @default(0)
  instagramUrl String?
  tiktokUrl   String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  barbers     Barber[]
  reviewList  Review[]
  media       WorkplaceMedia[]
  users       User[]          @relation("WorkplaceUsers")

  @@map("workplaces")
}

model Barber {
  id              String        @id @default(cuid())
  name            String
  email           String        @unique
  slug            String?       @unique
  specialty       String
  specialtyId     String?
  experienceYears Int
  rating          Float         @default(0.0)
  reviews         Int           @default(0)
  price           Float?
  distance        String?
  location        String
  latitude        Float?
  longitude       Float?
  image           String
  bio             String?
  workplaceId     String?
  serviceType     String?
  instagramUrl    String?
  tiktokUrl       String?
  wallScore       Float         @default(0)
  wallScoreUpdatedAt DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  appointments    Appointment[]
  favorites       FavoriteBarber[]
  portfolio       BarberMedia[]
  workplaceRef    Workplace?    @relation(fields: [workplaceId], references: [id])
  specialtyRef    Specialty?    @relation(fields: [specialtyId], references: [id])
  promotions      Promotion[]
  services        Service[]
  reviewList      Review[]
  availability    BarberAvailability[]
  availabilityExceptions BarberAvailabilityException[]
  courses         BarberCourse[]
  periodPoints    BarberPeriodPoints[]
  winnerPeriods   CompetitionPeriod[]  @relation("CompetitionWinner")

  @@map("barbers")
}

model CompetitionPeriod {
  id                       String                   @id @default(cuid())
  name                     String?
  startDate                DateTime
  endDate                  DateTime
  status                   CompetitionPeriodStatus  @default(DRAFT)
  winnerBarberId           String?
  prize                    String?
  closedAt                 DateTime?
  finalStandingsSnapshot   Json?
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt

  winner          Barber?                  @relation("CompetitionWinner", fields: [winnerBarberId], references: [id], onDelete: SetNull)
  points          BarberPeriodPoints[]

  @@index([status])
  @@index([startDate, endDate])
  @@map("competition_periods")
}

model BarberPeriodPoints {
  id        String   @id @default(cuid())
  barberId  String
  periodId  String
  points    Int      @default(0)
  updatedAt DateTime @updatedAt

  barber    Barber            @relation(fields: [barberId], references: [id], onDelete: Cascade)
  period    CompetitionPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  @@unique([barberId, periodId])
  @@index([periodId])
  @@index([barberId])
  @@map("barber_period_points")
}

model CompetitionHelpRule {
  id        String   @id @default(cuid())
  content   String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  @@index([sortOrder])
  @@map("competition_help_rules")
}

model Service {
  id          String        @id @default(cuid())
  barberId    String
  name        String
  price       Float
  description String?
  includes    String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  barber      Barber        @relation(fields: [barberId], references: [id], onDelete: Cascade)
  appointments Appointment[]

  @@index([barberId])
  @@map("services")
}

model BarberMedia {
  id        String   @id @default(cuid())
  barberId  String
  type      String
  url       String
  thumbnail String?
  caption   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  barber    Barber   @relation(fields: [barberId], references: [id], onDelete: Cascade)

  @@index([barberId])
  @@map("barber_media")
}

model WorkplaceMedia {
  id          String    @id @default(cuid())
  workplaceId String
  type        String
  url         String
  thumbnail   String?
  caption     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workplace   Workplace @relation(fields: [workplaceId], references: [id], onDelete: Cascade)

  @@index([workplaceId])
  @@map("workplace_media")
}

model Appointment {
  id            String   @id @default(cuid())
  userId        String?
  clientName    String?
  clientPhone   String?
  barberId      String
  serviceId     String?
  date          DateTime
  time          String
  status        String   @default("PENDING")
  paymentMethod String?
  paymentStatus String?  @default("PENDING") // PENDING, VERIFIED, REJECTED
  paymentProof  String?  // URL del comprobante de pago
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  barber        Barber   @relation(fields: [barberId], references: [id], onDelete: Cascade)
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  service       Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)

  @@unique([barberId, date, time]) // Prevenir doble reserva del mismo slot
  @@index([userId])
  @@index([barberId])
  @@index([date])
  @@index([serviceId])
  @@index([paymentStatus])
  @@map("appointments")
}

model Promotion {
  id             String   @id @default(cuid())
  title          String
  description    String
  code           String   @unique
  discount       Float?
  discountAmount Float?
  validFrom      DateTime
  validUntil     DateTime
  isActive       Boolean  @default(true)
  image          String?
  barberId       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  barber         Barber?  @relation(fields: [barberId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([validUntil])
  @@map("promotions")
}

model Review {
  id          String   @id @default(cuid())
  userId      String
  barberId    String?
  workplaceId String?
  rating      Int      // 1-5
  comment     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  barber      Barber?  @relation(fields: [barberId], references: [id], onDelete: Cascade)
  workplace   Workplace? @relation(fields: [workplaceId], references: [id], onDelete: Cascade)

  @@index([barberId])
  @@index([workplaceId])
  @@index([userId])
  @@map("reviews")
}

model PaymentMethod {
  id          String   @id @default(cuid())
  name        String   @unique
  icon        String?  // Emoji or icon name
  type        String?  // "BINANCE", "PAGO_MOVIL", "EFECTIVO", "TRANSFERENCIA", etc.
  config      Json?    // Configuración específica del método (datos de cuenta, teléfono, etc.)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("payment_methods")
}

model BarberAvailability {
  id          String   @id @default(cuid())
  barberId    String
  dayOfWeek   Int      // 0 = Domingo, 1 = Lunes, ..., 6 = Sábado
  startTime   String   // "08:00"
  endTime     String   // "18:00"
  isAvailable Boolean  @default(true)
  breakStart  String?  // "13:00" (opcional, hora de inicio del break)
  breakEnd    String?  // "14:00" (opcional, hora de fin del break)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  barber      Barber   @relation(fields: [barberId], references: [id], onDelete: Cascade)

  @@unique([barberId, dayOfWeek])
  @@index([barberId])
  @@map("barber_availability")
}

model BarberAvailabilityException {
  id          String   @id @default(cuid())
  barberId    String
  date        DateTime // Fecha específica
  isAvailable Boolean  // false = cerrado, true = horario especial
  startTime   String?  // Si isAvailable = true, horario especial
  endTime     String?
  breakStart  String?
  breakEnd    String?
  reason      String?  // "Vacaciones", "Día festivo", etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  barber      Barber   @relation(fields: [barberId], references: [id], onDelete: Cascade)

  @@unique([barberId, date])
  @@index([barberId])
  @@index([date])
  @@map("barber_availability_exceptions")
}

model BarberCourse {
  id             String              @id @default(cuid())
  barberId       String
  title          String
  institution    String?             // Institución donde realizó el curso
  description    String?
  completedAt    DateTime?           // Fecha de finalización
  duration       String?             // Duración del curso (ej: "40 horas", "3 meses")
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  barber         Barber              @relation(fields: [barberId], references: [id], onDelete: Cascade)
  media          BarberCourseMedia[] // Múltiples documentos/fotos del curso

  @@index([barberId])
  @@map("barber_courses")
}

model BarberCourseMedia {
  id        String       @id @default(cuid())
  courseId  String
  type      String       // "image", "document", "pdf", etc.
  url       String       // URL del archivo en Cloudinary
  thumbnail String?      // Thumbnail para imágenes
  caption   String?      // Descripción del documento (ej: "Certificado", "Diploma", "Foto del curso")
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  course    BarberCourse @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@map("barber_course_media")
}

model FcmToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  deviceType String  // "android" | "ios"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("fcm_tokens")
}

model Campaign {
  id            String   @id @default(cuid())
  title         String   // Título de la notificación
  message       String   // Mensaje/body de la notificación
  targetType    String   // "all" | "specific_users" | "barbers_only" | "clients_only"
  targetUserIds Json?    // Array de userIds si targetType es "specific_users"
  sentAt        DateTime? // Fecha/hora en que se envió
  sentCount     Int      @default(0) // Cantidad de notificaciones enviadas
  createdBy     String?  // ID del usuario que creó la campaña
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([targetType])
  @@index([createdAt])
  @@map("campaigns")
}

model AppVersion {
  id                String     @id @default(cuid())
  version           String     // Versión semántica: "1.0.0"
  versionCode       Int        @unique // Código de versión incremental: 1, 2, 3...
  apkUrl            String     // URL del archivo APK
  apkSize           Int        // Tamaño del archivo en bytes
  releaseNotes      String?    // Notas de la versión (Markdown o texto plano)
  isActive          Boolean    @default(false) // Solo una versión puede estar activa
  downloadCount     Int        @default(0) // Contador de descargas
  minimumVersionCode Int?      // Versión mínima requerida (versionCode)
  updateUrl         String?    // URL personalizada de descarga
  updateType        String?    // "store" | "url" | "apk"
  forceUpdate       Boolean    @default(false) // Forzar actualización
  createdBy         String?    // ID del usuario que subió la versión
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  downloads         Download[]

  @@index([isActive])
  @@index([versionCode])
  @@index([createdAt])
  @@map("app_versions")
}

model Download {
  id          String      @id @default(cuid())
  versionId   String
  ipAddress   String?
  userAgent   String?
  downloadedAt DateTime   @default(now())
  version     AppVersion  @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([versionId])
  @@index([downloadedAt])
  @@map("downloads")
}

model LegalDocument {
  id        String   @id @default(cuid())
  type      String   // "privacy" | "terms" | "cookies"
  title     String
  content   String   // Markdown o HTML
  version   Int      @default(1)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  // ID del usuario que creó/actualizó el documento

  @@unique([type, version])
  @@index([type])
  @@index([isActive])
  @@index([createdAt])
  @@map("legal_documents")
}

model AnalyticsEvent {
  id          String   @id @default(cuid())
  eventType   String   // "user_action" | "system_event" | "error" | "performance"
  eventName   String   // Nombre específico del evento (ej: "appointment_created")
  platform    String   // "app" | "landing" | "backend"
  userId      String?  // ID del usuario (si aplica)
  sessionId   String?  // ID de sesión
  properties  Json?    // Propiedades adicionales del evento
  metadata    Json?    // Metadata técnica (userAgent, IP, appVersion, etc.)
  createdAt   DateTime @default(now())

  @@index([eventType, createdAt])        // Filtrar por tipo y fecha
  @@index([eventName, createdAt])        // Filtrar por nombre y fecha
  @@index([platform, createdAt])       // Filtrar por plataforma y fecha
  @@index([userId, createdAt])          // Eventos de un usuario
  @@index([createdAt])                  // Ordenar por fecha
  @@index([sessionId])                  // Eventos de una sesión
  @@map("analytics_events")
}

model FavoriteBarber {
  userId    String
  barberId  String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  barber    Barber   @relation(fields: [barberId], references: [id], onDelete: Cascade)

  @@id([userId, barberId])
  @@map("favorite_barbers")
}
